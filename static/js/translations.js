/**
 * Système de traduction complet Français/Arabe
 * Pour la plateforme Hôpital EL GHASSANI
 */

const translations = {
    // Navigation
    'Dashboard': {
        'fr': 'Tableau de bord',
        'ar': 'لوحة التحكم'
    },
    'Dossiers Médicaux': {
        'fr': 'Dossiers Médicaux',
        'ar': 'الملفات الطبية'
    },
    'Dossiers': {
        'fr': 'Dossiers',
        'ar': 'الملفات'
    },
    'Patients': {
        'fr': 'Patients',
        'ar': 'المرضى'
    },
    'Documents': {
        'fr': 'Documents',
        'ar': 'الوثائق'
    },
    'Rapports': {
        'fr': 'Rapports',
        'ar': 'التقارير'
    },
    'Scanner': {
        'fr': 'Scanner',
        'ar': 'الماسح الضوئي'
    },
    'Administration': {
        'fr': 'Administration',
        'ar': 'الإدارة'
    },
    'Médecins': {
        'fr': 'Médecins',
        'ar': 'الأطباء'
    },
    'Utilisateurs': {
        'fr': 'Utilisateurs',
        'ar': 'المستخدمون'
    },
    'Paramètres': {
        'fr': 'Paramètres',
        'ar': 'الإعدادات'
    },
    'Historique': {
        'fr': 'Historique',
        'ar': 'السجل'
    },
    'Coffre-fort': {
        'fr': 'Coffre-fort',
        'ar': 'الخزنة'
    },
    'Messages': {
        'fr': 'Messages',
        'ar': 'الرسائل'
    },
    'Activités': {
        'fr': 'Activités',
        'ar': 'الأنشطة'
    },
    'Système': {
        'fr': 'Système',
        'ar': 'النظام'
    },
    'Profil': {
        'fr': 'Profil',
        'ar': 'الملف الشخصي'
    },
    'Préférences': {
        'fr': 'Préférences',
        'ar': 'التفضيلات'
    },
    'Déconnexion': {
        'fr': 'Déconnexion',
        'ar': 'تسجيل الخروج'
    },

    // Boutons
    'Ajouter': {
        'fr': 'Ajouter',
        'ar': 'إضافة'
    },
    'Nouveau': {
        'fr': 'Nouveau',
        'ar': 'جديد'
    },
    'Modifier': {
        'fr': 'Modifier',
        'ar': 'تعديل'
    },
    'Supprimer': {
        'fr': 'Supprimer',
        'ar': 'حذف'
    },
    'Enregistrer': {
        'fr': 'Enregistrer',
        'ar': 'حفظ'
    },
    'Annuler': {
        'fr': 'Annuler',
        'ar': 'إلغاء'
    },
    'Rechercher': {
        'fr': 'Rechercher',
        'ar': 'بحث'
    },
    'Exporter': {
        'fr': 'Exporter',
        'ar': 'تصدير'
    },
    'Importer': {
        'fr': 'Importer',
        'ar': 'استيراد'
    },
    'Voir': {
        'fr': 'Voir',
        'ar': 'عرض'
    },
    'Fermer': {
        'fr': 'Fermer',
        'ar': 'إغلاق'
    },
    'Retour': {
        'fr': 'Retour',
        'ar': 'رجوع'
    },

    // Statuts
    'Actif': {
        'fr': 'Actif',
        'ar': 'نشط'
    },
    'Inactif': {
        'fr': 'Inactif',
        'ar': 'غير نشط'
    },
    'En attente': {
        'fr': 'En attente',
        'ar': 'قيد الانتظار'
    },
    'En cours': {
        'fr': 'En cours',
        'ar': 'قيد التنفيذ'
    },
    'Terminé': {
        'fr': 'Terminé',
        'ar': 'منتهي'
    },
    'Terminée': {
        'fr': 'Terminée',
        'ar': 'منتهية'
    },
    'Urgent': {
        'fr': 'Urgent',
        'ar': 'عاجل'
    },
    'Urgente': {
        'fr': 'Urgente',
        'ar': 'عاجل'
    },
    'Normal': {
        'fr': 'Normal',
        'ar': 'عادي'
    },
    'Normale': {
        'fr': 'Normale',
        'ar': 'عادي'
    },
    'Élevé': {
        'fr': 'Élevé',
        'ar': 'مرتفع'
    },
    'Élevée': {
        'fr': 'Élevée',
        'ar': 'مرتفعة'
    },

    // Formulaires
    'Nom': {
        'fr': 'Nom',
        'ar': 'الاسم'
    },
    'Prénom': {
        'fr': 'Prénom',
        'ar': 'الاسم الأول'
    },
    'Email': {
        'fr': 'Email',
        'ar': 'البريد الإلكتروني'
    },
    'Téléphone': {
        'fr': 'Téléphone',
        'ar': 'الهاتف'
    },
    'Adresse': {
        'fr': 'Adresse',
        'ar': 'العنوان'
    },
    'Date de naissance': {
        'fr': 'Date de naissance',
        'ar': 'تاريخ الميلاد'
    },
    'Âge': {
        'fr': 'Âge',
        'ar': 'العمر'
    },
    'Sexe': {
        'fr': 'Sexe',
        'ar': 'الجنس'
    },
    'Homme': {
        'fr': 'Homme',
        'ar': 'ذكر'
    },
    'Femme': {
        'fr': 'Femme',
        'ar': 'أنثى'
    },
    'Titre': {
        'fr': 'Titre',
        'ar': 'العنوان'
    },
    'Description': {
        'fr': 'Description',
        'ar': 'الوصف'
    },
    'Type': {
        'fr': 'Type',
        'ar': 'النوع'
    },
    'Date': {
        'fr': 'Date',
        'ar': 'التاريخ'
    },
    'Statut': {
        'fr': 'Statut',
        'ar': 'الحالة'
    },
    'Priorité': {
        'fr': 'Priorité',
        'ar': 'الأولوية'
    },
    'Actions': {
        'fr': 'Actions',
        'ar': 'الإجراءات'
    },

    // Page Patients
    'Liste des Patients': {
        'fr': 'Liste des Patients',
        'ar': 'قائمة المرضى'
    },
    'Nouveau Patient': {
        'fr': 'Nouveau Patient',
        'ar': 'مريض جديد'
    },
    'Total Patients': {
        'fr': 'Total Patients',
        'ar': 'إجمالي المرضى'
    },
    'Patients Actifs': {
        'fr': 'Patients Actifs',
        'ar': 'المرضى النشطون'
    },
    'Nouveaux ce mois': {
        'fr': 'Nouveaux ce mois',
        'ar': 'جدد هذا الشهر'
    },
    'En consultation': {
        'fr': 'En consultation',
        'ar': 'في الاستشارة'
    },
    'Rechercher un patient': {
        'fr': 'Rechercher un patient',
        'ar': 'البحث عن مريض'
    },
    'Tous les statuts': {
        'fr': 'Tous les statuts',
        'ar': 'جميع الحالات'
    },
    'Numéro Patient': {
        'fr': 'Numéro Patient',
        'ar': 'رقم المريض'
    },
    'Carte d\'identité': {
        'fr': 'Carte d\'identité',
        'ar': 'بطاقة الهوية'
    },
    'Dernière visite': {
        'fr': 'Dernière visite',
        'ar': 'آخر زيارة'
    },

    // Page Documents
    'Liste des Documents': {
        'fr': 'Liste des Documents',
        'ar': 'قائمة الوثائق'
    },
    'Nouveau Document': {
        'fr': 'Nouveau Document',
        'ar': 'وثيقة جديدة'
    },
    'Total Documents': {
        'fr': 'Total Documents',
        'ar': 'إجمالي الوثائق'
    },
    'Documents Récents': {
        'fr': 'Documents Récents',
        'ar': 'الوثائق الأخيرة'
    },
    'Rechercher un document': {
        'fr': 'Rechercher un document',
        'ar': 'البحث عن وثيقة'
    },
    'Type de document': {
        'fr': 'Type de document',
        'ar': 'نوع الوثيقة'
    },
    'Tous les types': {
        'fr': 'Tous les types',
        'ar': 'جميع الأنواع'
    },

    // Page Rapports
    'Gestion des Rapports': {
        'fr': 'Gestion des Rapports',
        'ar': 'إدارة التقارير'
    },
    'Nouveau Rapport': {
        'fr': 'Nouveau Rapport',
        'ar': 'تقرير جديد'
    },
    'Rechercher un rapport': {
        'fr': 'Rechercher un rapport',
        'ar': 'البحث عن تقرير'
    },
    'Tous les médecins': {
        'fr': 'Tous les médecins',
        'ar': 'جميع الأطباء'
    },
    'Médecin responsable': {
        'fr': 'Médecin responsable',
        'ar': 'الطبيب المسؤول'
    },

    // Page Scanner
    'Scanner de Documents': {
        'fr': 'Scanner de Documents',
        'ar': 'ماسح الوثائق'
    },
    'Capturer': {
        'fr': 'Capturer',
        'ar': 'التقاط'
    },
    'Scans Récents': {
        'fr': 'Scans Récents',
        'ar': 'المسوحات الأخيرة'
    },
    'Documents Scannés': {
        'fr': 'Documents Scannés',
        'ar': 'الوثائق الممسوحة'
    },
    'Télécharger': {
        'fr': 'Télécharger',
        'ar': 'تحميل'
    },

    // Page Activités (Infirmiers)
    'Planning des Activités': {
        'fr': 'Planning des Activités',
        'ar': 'جدولة الأنشطة'
    },
    'Total Activités': {
        'fr': 'Total Activités',
        'ar': 'إجمالي الأنشطة'
    },
    'Terminées': {
        'fr': 'Terminées',
        'ar': 'المنتهية'
    },
    'Urgentes': {
        'fr': 'Urgentes',
        'ar': 'العاجلة'
    },
    'Soins': {
        'fr': 'Soins',
        'ar': 'العناية'
    },
    'Surveillance': {
        'fr': 'Surveillance',
        'ar': 'المراقبة'
    },
    'Administration de médicaments': {
        'fr': 'Administration de médicaments',
        'ar': 'إعطاء الأدوية'
    },
    'Contrôle des signes vitaux': {
        'fr': 'Contrôle des signes vitaux',
        'ar': 'فحص العلامات الحيوية'
    },
    'Pansement': {
        'fr': 'Pansement',
        'ar': 'الضمادة'
    },
    'Chambre': {
        'fr': 'Chambre',
        'ar': 'الغرفة'
    },
    'Heure prévue': {
        'fr': 'Heure prévue',
        'ar': 'الوقت المحدد'
    },

    // Page Médecins
    'Gestion des Médecins': {
        'fr': 'Gestion des Médecins',
        'ar': 'إدارة الأطباء'
    },
    'Ajouter un Médecin': {
        'fr': 'Ajouter un Médecin',
        'ar': 'إضافة طبيب'
    },
    'Médecins actifs': {
        'fr': 'Médecins actifs',
        'ar': 'الأطباء النشطون'
    },
    'Départements': {
        'fr': 'Départements',
        'ar': 'الأقسام'
    },
    'Spécialités': {
        'fr': 'Spécialités',
        'ar': 'التخصصات'
    },
    'En ligne': {
        'fr': 'En ligne',
        'ar': 'متصل'
    },
    'Département': {
        'fr': 'Département',
        'ar': 'القسم'
    },
    'Spécialité': {
        'fr': 'Spécialité',
        'ar': 'التخصص'
    },
    'Contact': {
        'fr': 'Contact',
        'ar': 'الاتصال'
    },

    // Départements
    'Cardiologie': {
        'fr': 'Cardiologie',
        'ar': 'أمراض القلب'
    },
    'Pédiatrie': {
        'fr': 'Pédiatrie',
        'ar': 'طب الأطفال'
    },
    'Radiologie': {
        'fr': 'Radiologie',
        'ar': 'الأشعة'
    },
    'Chirurgie': {
        'fr': 'Chirurgie',
        'ar': 'الجراحة'
    },
    'Gynécologie': {
        'fr': 'Gynécologie',
        'ar': 'أمراض النساء'
    },
    'Urgences': {
        'fr': 'Urgences',
        'ar': 'الطوارئ'
    },
    'Neurologie': {
        'fr': 'Neurologie',
        'ar': 'الأعصاب'
    },
    'Dermatologie': {
        'fr': 'Dermatologie',
        'ar': 'الأمراض الجلدية'
    },
    'ORL': {
        'fr': 'ORL',
        'ar': 'الأنف والأذن والحنجرة'
    },

    // Dashboard
    'Bienvenue': {
        'fr': 'Bienvenue',
        'ar': 'مرحبا'
    },
    'Bonjour': {
        'fr': 'Bonjour',
        'ar': 'صباح الخير'
    },
    'Statistiques': {
        'fr': 'Statistiques',
        'ar': 'الإحصائيات'
    },
    'Aperçu': {
        'fr': 'Aperçu',
        'ar': 'نظرة عامة'
    },
    'Cette semaine': {
        'fr': 'Cette semaine',
        'ar': 'هذا الأسبوع'
    },
    'Ce mois': {
        'fr': 'Ce mois',
        'ar': 'هذا الشهر'
    },
    'Aujourd\'hui': {
        'fr': 'Aujourd\'hui',
        'ar': 'اليوم'
    },

    // Messages communs
    'Aucun résultat': {
        'fr': 'Aucun résultat',
        'ar': 'لا توجد نتائج'
    },
    'Chargement': {
        'fr': 'Chargement',
        'ar': 'جاري التحميل'
    },
    'Succès': {
        'fr': 'Succès',
        'ar': 'نجح'
    },
    'Erreur': {
        'fr': 'Erreur',
        'ar': 'خطأ'
    },
    'Confirmer': {
        'fr': 'Confirmer',
        'ar': 'تأكيد'
    },
    'Oui': {
        'fr': 'Oui',
        'ar': 'نعم'
    },
    'Non': {
        'fr': 'Non',
        'ar': 'لا'
    },

    // Placeholders
    'Rechercher...': {
        'fr': 'Rechercher...',
        'ar': 'بحث...'
    },
    'Rechercher un patient...': {
        'fr': 'Rechercher un patient...',
        'ar': 'البحث عن مريض...'
    },
    'Rechercher un document...': {
        'fr': 'Rechercher un document...',
        'ar': 'البحث عن وثيقة...'
    },
    'Rechercher un rapport...': {
        'fr': 'Rechercher un rapport...',
        'ar': 'البحث عن تقرير...'
    },
    'Sélectionner...': {
        'fr': 'Sélectionner...',
        'ar': 'اختر...'
    },
    'Entrez votre texte': {
        'fr': 'Entrez votre texte',
        'ar': 'أدخل النص'
    },
    'Entrez votre nom': {
        'fr': 'Entrez votre nom',
        'ar': 'أدخل اسمك'
    },
    'Entrez votre prénom': {
        'fr': 'Entrez votre prénom',
        'ar': 'أدخل اسمك الأول'
    },
    'Entrez votre email': {
        'fr': 'Entrez votre email',
        'ar': 'أدخل بريدك الإلكتروني'
    },
    'Entrez votre téléphone': {
        'fr': 'Entrez votre téléphone',
        'ar': 'أدخل رقم هاتفك'
    },
    
    // Textes de page
    'Gestion des Patients': {
        'fr': 'Gestion des Patients',
        'ar': 'إدارة المرضى'
    },
    'Gestion des Documents': {
        'fr': 'Gestion des Documents',
        'ar': 'إدارة الوثائق'
    },
    'Tous': {
        'fr': 'Tous',
        'ar': 'الكل'
    },
    'Toutes': {
        'fr': 'Toutes',
        'ar': 'الكل'
    },
    'Aucun': {
        'fr': 'Aucun',
        'ar': 'لا شيء'
    },
    'Aucune': {
        'fr': 'Aucune',
        'ar': 'لا شيء'
    },
};

/**
 * Fonction pour traduire le texte
 */
function translate(text, lang) {
    if (!text) return '';
    
    // Chercher dans le dictionnaire
    if (translations[text] && translations[text][lang]) {
        return translations[text][lang];
    }
    
    // Si pas trouvé, retourner le texte original
    return text;
}

/**
 * Fonction pour traduire toute la page
 */
function translatePage(lang) {
    console.log('[translatePage] Traduction vers:', lang);
    
    // Sauvegarder la langue choisie
    localStorage.setItem('language', lang);
    localStorage.setItem('pref_language', lang);
    
    // Définir la direction (RTL pour arabe)
    if (lang === 'ar') {
        document.documentElement.setAttribute('dir', 'rtl');
        document.documentElement.setAttribute('lang', 'ar');
        document.body.classList.add('rtl');
    } else {
        document.documentElement.setAttribute('dir', 'ltr');
        document.documentElement.setAttribute('lang', 'fr');
        document.body.classList.remove('rtl');
    }
    
    let translatedCount = 0;
    
    // 1. Traduire tous les éléments avec data-translate
    document.querySelectorAll('[data-translate]').forEach(element => {
        const key = element.getAttribute('data-translate');
        const translated = translate(key, lang);
        
        if (translated !== key) {
            // Vérifier le type d'élément
            if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                // Pour les champs de formulaire, traduire le placeholder
                if (element.hasAttribute('placeholder')) {
                    element.placeholder = translated;
                }
            } else if (element.tagName === 'OPTION') {
                // Pour les options de select
                element.textContent = translated;
            } else {
                // Pour les autres éléments, traduire le contenu
                // Préserver les icônes et autres éléments enfants
                const icon = element.querySelector('i');
                if (icon) {
                    element.innerHTML = '';
                    element.appendChild(icon.cloneNode(true));
                    element.appendChild(document.createTextNode(' ' + translated));
                } else {
                    element.textContent = translated;
                }
            }
            translatedCount++;
        }
    });
    
    // 2. Traduire les éléments communs SANS data-translate
    translateCommonElements(lang);
    
    // 3. Traduire les placeholders
    translatePlaceholders(lang);
    
    // 4. Mettre à jour le bouton de langue
    const langButton = document.querySelector('.language-selector .dropdown-toggle');
    if (langButton) {
        if (lang === 'ar') {
            langButton.innerHTML = '<i class="fas fa-language me-1"></i>العربية';
        } else {
            langButton.innerHTML = '<i class="fas fa-language me-1"></i>Français';
        }
    }
    
    // 5. Appliquer les styles RTL si nécessaire
    applyRTLStyles(lang === 'ar');
    
    console.log(`[translatePage] ✅ ${translatedCount} éléments traduits en ${lang === 'ar' ? 'arabe' : 'français'}`);
}

/**
 * Traduire les éléments communs sans data-translate
 */
function translateCommonElements(lang) {
    // Navigation
    const navLinks = document.querySelectorAll('.nav-link, .dropdown-item');
    navLinks.forEach(link => {
        if (link.hasAttribute('data-translate')) return; // Déjà traité
        
        const text = link.textContent.trim();
        const translated = translate(text, lang);
        if (translated !== text) {
            const icon = link.querySelector('i');
            if (icon) {
                link.innerHTML = '';
                link.appendChild(icon.cloneNode(true));
                link.appendChild(document.createTextNode(' ' + translated));
            } else {
                link.textContent = translated;
            }
        }
    });
    
    // Boutons
    const buttons = document.querySelectorAll('button, .btn');
    buttons.forEach(btn => {
        if (btn.hasAttribute('data-translate')) return;
        
        const text = btn.textContent.trim();
        const translated = translate(text, lang);
        if (translated !== text && text.length > 0 && text.length < 50) {
            const icon = btn.querySelector('i');
            if (icon) {
                btn.innerHTML = '';
                btn.appendChild(icon.cloneNode(true));
                btn.appendChild(document.createTextNode(' ' + translated));
            } else {
                btn.textContent = translated;
            }
        }
    });
    
    // Titres
    const headers = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
    headers.forEach(header => {
        if (header.hasAttribute('data-translate')) return;
        
        const text = header.textContent.trim();
        const translated = translate(text, lang);
        if (translated !== text) {
            const icon = header.querySelector('i');
            if (icon) {
                header.innerHTML = '';
                header.appendChild(icon.cloneNode(true));
                header.appendChild(document.createTextNode(' ' + translated));
            } else {
                header.textContent = translated;
            }
        }
    });
    
    // Labels
    const labels = document.querySelectorAll('label');
    labels.forEach(label => {
        if (label.hasAttribute('data-translate')) return;
        
        const text = label.textContent.trim();
        const translated = translate(text, lang);
        if (translated !== text && text.length > 0 && text.length < 50) {
            label.textContent = translated;
        }
    });
    
    // Table headers
    const ths = document.querySelectorAll('th');
    ths.forEach(th => {
        if (th.hasAttribute('data-translate')) return;
        
        const text = th.textContent.trim();
        const translated = translate(text, lang);
        if (translated !== text && text.length > 0 && text.length < 30) {
            th.textContent = translated;
        }
    });
}

/**
 * Traduire les placeholders
 */
function translatePlaceholders(lang) {
    const inputs = document.querySelectorAll('input[placeholder], textarea[placeholder]');
    inputs.forEach(input => {
        const placeholder = input.getAttribute('placeholder');
        const translated = translate(placeholder, lang);
        if (translated !== placeholder) {
            input.setAttribute('placeholder', translated);
        }
    });
}

/**
 * Appliquer les styles RTL
 */
function applyRTLStyles(isRTL) {
    const styleId = 'rtl-styles';
    let styleElement = document.getElementById(styleId);
    
    if (isRTL) {
        if (!styleElement) {
            styleElement = document.createElement('style');
            styleElement.id = styleId;
            styleElement.textContent = `
                body.rtl {
                    direction: rtl;
                    text-align: right;
                }
                body.rtl .navbar-brand {
                    margin-left: auto;
                    margin-right: 0;
                }
                body.rtl .dropdown-menu {
                    text-align: right;
                }
                body.rtl .me-1, body.rtl .me-2, body.rtl .me-3 {
                    margin-right: 0 !important;
                    margin-left: 0.25rem !important;
                }
                body.rtl .ms-1, body.rtl .ms-2, body.rtl .ms-3 {
                    margin-left: 0 !important;
                    margin-right: 0.25rem !important;
                }
                body.rtl .text-end {
                    text-align: left !important;
                }
                body.rtl .text-start {
                    text-align: right !important;
                }
                body.rtl .float-end {
                    float: left !important;
                }
                body.rtl .float-start {
                    float: right !important;
                }
                body.rtl table {
                    direction: rtl;
                }
                body.rtl .badge {
                    direction: rtl;
                }
            `;
            document.head.appendChild(styleElement);
        }
    } else {
        if (styleElement) {
            styleElement.remove();
        }
    }
}

/**
 * Initialiser la traduction au chargement de la page
 */
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Translations] Initialisation du système de traduction...');
    
    // Récupérer la langue sauvegardée
    const savedLang = localStorage.getItem('language') || localStorage.getItem('pref_language') || 'fr';
    console.log('[Translations] Langue sauvegardée:', savedLang);
    
    // Appliquer la traduction après un court délai pour laisser la page charger
    setTimeout(() => {
        translatePage(savedLang);
        console.log('[Translations] Traduction appliquée pour:', savedLang);
    }, 500);
    
    // Écouter les changements de langue
    document.addEventListener('languageChanged', function(e) {
        console.log('[Translations] Changement de langue vers:', e.detail.language);
        translatePage(e.detail.language);
    });
});

// Export pour utilisation globale
window.translate = translate;
window.translatePage = translatePage;

console.log('[Translations] Module chargé avec', Object.keys(translations).length, 'traductions');

